# R Markdown

```{info, title = "Note", collapsible = FALSE}
An awesome reference for all things `rmarkdown` is the **R Markdown Cookbook**, which can be found at
[https://bookdown.org/yihui/rmarkdown-cookbook/](https://bookdown.org/yihui/rmarkdown-cookbook/)
```

We have seen that it is possible to generate quick reports directly from R script files. However, this lacks any ability to control the formatting of the output. To this end we can start to think about creating a simple R Markdown script.

An R Markdown script is usually suffixed with `.Rmd`, but is simply a text file in the same way that standard R scripts are. RStudio offers a useful default template that can be used to initialise a new document. Go to *File > New File > R Markdown*, and you get an option window that looks like Figure \@ref(fig:rmarkdown). In the first instance choose the **HTML** option and click `OK`.

```{r, rmarkdown, fig.cap = "R Markdown choices", echo = FALSE, out.width = "50%", out.height = "50%"}
include_graphics("litprog/images/rmarkdownchoices.png")
```

This creates a new document which looks like Figure \@ref(fig:rmarkdowntmp):

```{r, rmarkdowntmp, fig.cap = "R Markdown template", echo = FALSE, out.width = "80%", out.height = "80%"}
include_graphics("litprog/images/rmarkdown.png")
```

```{task}
To start with, click the 'Knit' button shown by the red circle in the figure above to typeset the document (you will have to save the R Markdown document in your working directory---I called it `test.Rmd`). You can see that it's produced a HTML document with the code and output weaved together. (As an aside, `cars` is a dataset provided in the `datasets` package loaded automatically by R---see `?cars`.) 
     
Try compiling to a PDF, or a Word document by clicking on the arrow next to the 'Knit' button and choosing accordingly.
``` 

Let's talk through the different components of the Markdown code.

```{info, title = "Very important", collapsible = FALSE}
When you compile an R Markdown document (using e.g. the 'Knit' button), the software compiles the code within an isolated sandbox. This means that it cannot see your current workspace, or any libraries you might have loaded, or anything else you might have done in your main R session. This is important to make sure that the code is entirely **reproducible**. 

One consequence of this is that when compiling, it automatically sets the **working directory** to the directory containing the `.Rmd` file. 

Setting the working directory inside a piece of R code (using e.g. `setwd()`) **will not apply to the whole document**. This means that if you are including **paths to any files**, then these must be either *fully specified*, or specified *relative to the directory* that the `.Rmd` file is in. The latter is preferred, since this will also work if you share the `.Rmd` file with anyone else.

So, in short, **always treat the working directory as being the location of your `.Rmd` file** in any piece of R Markdown code, and do not try to override this with e.g. `setwd()`.
```

## YAML

The top section is called the YAML. (This stands for "YAML Ain't Markup Language"---a [recursive acronym](https://en.wikipedia.org/wiki/Recursive_acronym) of the sort favoured by programmers worldwide.)

```{r, echo = FALSE, comment = NA}
cat("---
title: \"Untitled\"
output: html_document
---")
```

The YAML contains information about the **document**, and has various options, including: `title`, `author`, `output`, `date`, `toc` (table of contents) and so on. The YAML can also be used to provide different options depending on the output document type, for example HTML or PDF.

## Formatting

Formatting in R Markdown is very simple. For example:

* `#` denote **sections**, with subsections denoted by including more hashes (for example `##` denotes a second-level sub-section and so on).
* *Italics* are typeset by enclosing a word or section in single `*` symbols, for example: `*this is in italics*` will typeset: *this is in italics*. 
* **Bold** type is written by enclosing a word or section in double `*` symbols, for example: `**this is bold**` will typeset: **this is bold**.
* Hyperlinks are implemented using the notation `[TEXT](LINK)`, so `[R Markdown Cookbook](https://bookdown.org/yihui/rmarkdown-cookbook/)` typesets as [R Markdown Cookbook](https://bookdown.org/yihui/rmarkdown-cookbook/).

There are many more options, far too many to list here. However, a more complete list of formatting options can be found in the [R Markdown Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf). 

A more detailed book covering all sorts of options is the [R Markdown Cookbook](https://bookdown.org/yihui/rmarkdown-cookbook/).

```{task}
Take a look at the [R Markdown Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf) and familiarise yourself with the options. We will cover some of them below.
```

## R code chunks

R code chunks can be included by enclosing with backticks `` ``` ``. For example,

```{r, comment = NA, echo = FALSE}
cat("```{r}
summary(cars)
```")
```

will run the code inside the **chunk** i.e. `summary(cars)`. It will then insert the results from running the code into the output document, so when typeset you will obtain something like:

```{r}
summary(cars)
```

The **chunk** can take various options, which must be included in the set of curly brackets. The first line `` ```{r} ``, says that we use the R engine to process the chunk (i.e. that the code inside the chunk should be run in R). The `knitr` package allows for other languages (such as Python) to also be used inside code chunks. 

For example, if we want to typeset the code chunk but **not run it**, we can use the `eval` option to turn code evaluation off e.g.

```{r, comment = NA, echo = FALSE}
cat("```{r, eval = FALSE}
summary(cars)
```")
```

will produce

```{r, eval = FALSE}
summary(cars)
```

**(Note: no output chunk.)**

Similarly, we can **hide the source code** by using the `echo` option e.g.

```{r, comment = NA, echo = FALSE}
cat("```{r, echo = FALSE}
summary(cars)
```")
```

will produce

```{r, echo = FALSE}
summary(cars)
```

**(Note: no source code chunk.)**

There are various options that can be passed to code chunks, perhaps the most useful being `echo` and `eval` (to decide whether source code should be run and/or displayed). A full list of options is given in the [R Markdown Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf).

```{task}
Have a play with different chunk options using this test document and the [R Markdown Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf). Familiarise yourselves with the `eval` and `echo` options in particular.
```

### Global options

Notice in this template document that there is a chunk at the beginning that looks like

```{r, comment = NA, echo = FALSE}
cat("```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```")
```

The function `opts_chunk$set()` allows the user to set **global options**. In this case setting the `echo` option to be `TRUE` by default. **(Note that options added to individual code chunks override these global options, so I can still set `echo = FALSE` for specific chunks if required.)** Notice also the use of the option `include = FALSE` to this chunk. This means that the function is run, but neither the source code or outputs are included in the compiled document. This is useful here, since the contents of this chunk relate to the processing of the R Markdown document, and do not play any role in the "analysis".

```{info, title = "Aside", collapsible = FALSE}
The `opts_chunk$set()` function is part of the `knitr` package, and the `knitr::` part is just making this explicit. As long as the `knitr` package is loaded (using `library(knitr)`), then you do not need to add the `knitr::` part. This format can be useful if you want to use specific functions from a package, but without loading the whole library. There are some technicalities around this (RStudio loads the `namespace` of `knitr` already---this is not true for all packages), so a more general option would be:
    
``{r, comment = NA, echo = FALSE}
cat("``{r setup, include = FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)
``")
``

```

This is a useful feature, for example, I often use global options to set figure dimensions (and other useful features, like the `tidy` option, that tidies code and prevents long lines from over-running the edge of the code boxes) e.g.

```{r, comment = NA, echo = FALSE}
cat("```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, fig.align = \"center\", fig.width = 6, fig.height = 6, 
    tidy.opts = list(width.cutoff = 60), tidy = TRUE)
```")
```

```{info, title = "Note", collapsible = FALSE}
If you are loading `tidyverse` as part of an R Markdown document, and you want to knit to a PDF document using LaTeX, then it sometimes throws an error when loading because LaTeX can't process the correct fonts for the loading message. Hence in R Markdown documents I always suppress the load messages through the chunk option `message = FALSE` e.g.

``{r, comment = NA, echo = FALSE}
cat("``{r, message = FALSE}
library(tidyverse)
``")
``

```

### Named chunks

Chunks can also be **named**. In the example, one chunk looks like:
    
```{r, comment = NA, echo = FALSE}
cat("```{r cars}
summary(cars)
```")
```

Here they have **named** the chunk `cars` (the name is the first argument after the `r` engine indicator, unless we pass named arguments). Naming is useful if we wish to reuse chunks later on, without rewriting all the code. Personally I only name chunks if I wish to reuse them, although naming chunks can also be useful for tracking down compilation errors.

A key thing to note is that **chunks must have unique names**, else `knitr` will throw an error. If names are not provided, then `knitr` generates them for you. To reuse earlier named code chunks, one can create a chunk with the `ref.label` argument set to be the name of the chunk that you wish to re-run. In the example above, the chunk is named `cars`, and hence a *second chunk*:

```{r, comment = NA, echo = FALSE}
cat("```{r, ref.label = \"cars\"}
```")
```

will produce

```{r, cars, include = FALSE}
summary(cars)
```

```{r, ref.label= "cars"}
```

You can also use the `<< >>` operators within a chunk to do the same thing e.g.

`` ```{r} ``
`r ifelse(is_latex_output(), "\\newline", "<br>")`
`<<cars>>`
`r ifelse(is_latex_output(), "\\newline", "<br>")`
`` ``` ``

is equivalent to using `ref.label` above. (This latter approach has the additional advantage that you can add more R code around the `<<cars>>` statement if required.)

```{info, title = "Aside", collapsible = FALSE}
There is also a facility for including chunks specified in **external files**, using the `read_chunk()` function. We will not explore this here, but if you're interested, a nice example can be found in a [ZevRoss blog](http://zevross.com/blog/2014/07/09/making-use-of-external-r-code-in-knitr-and-r-markdown/).
```

### Inline chunks

R Markdown also allows for **inline chunks**. These are code chunks enclosed in **single backtick** characters. For example, a line written in R Markdown as, 

> The mean speed of cars is `r ifelse(opts_knit$get("rmarkdown.pandoc.to") == "html", "<code> &#96;r mean(cars$speed)&#96;</code>", "\\texttt{\\textasciigrave r mean(cars\\$speed)\\textasciigrave}")`

will typeset as, 

> The mean speed of cars is `r mean(cars$speed)`. 

Removing the `r` from the inline chunk will simply typeset the command as a piece of code, but does not evaluate it. Hence, 

> `r ifelse(opts_knit$get("rmarkdown.pandoc.to") == "html", "<code> &#96;mean(cars$speed)&#96;</code>", "\\texttt{\\textasciigrave mean(cars\\$speed)\\textasciigrave}")`

(note this is enclosed in single backticks `r ifelse(opts_knit$get("rmarkdown.pandoc.to") == "html", "&#96;</code>", "\\texttt{\\textasciigrave}")`), typesets as 

> `mean(cars$speed)`.

```{task}
Have a play with including inline code and typesetting commands using this test document and the [R Markdown Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf).
```

```{info, title = "Aside", collapsible = FALSE}
RStudio has options that allow you to run code chunks *in situ*. Note the little green arrow marked in the blue box in Figure \@ref(fig:rmarkdowntmp). Clicking this runs each code chunk and returns the output interspersed with the code, allowing for an even more interactive coding environment.
```

```{task}
Make a **copy** of the `ff.R` script file used [Chapter 9](#ffscript) (or copy the code from [here](#ffscript)), and save it as an R Markdown file (e.g. copy it to a file called `ff.Rmd`). Edit this file and turn it into a working R Markdown document, with explanations of the analysis interspersed with the code and the output. Make sure you add a **title** and **author** to the YAML.

**Note**: in the solution below I've added some further information about the study---taken from the earlier lecture notes, to illustrate some of the formatting options such as bullet point lists, **bold** and *italic* fonts, inline code and hyperlinks.
```

```{solution, code = readLines("litprog/ff.Rmd"), eval = FALSE}
```

## Figures and tables

### Figures

When creating plots from R, useful chunk options are `fig.width` and `fig.height`, which allow you to set the plot dimensions in inches. Alternatively, `out.width` and `out.height` can be used to scale figures in different ways, I mostly use e.g. `out.width = "50%"` to scale the width and height by 50% to make a smaller plot (`out.width` respects aspect ratios unless you specifically set `out.height` as well). Figure captions can be added using the `fig.cap` option. Alignment of the output figure can be controlled with `fig.align`, which takes the values `"left"`, `"right"` or `"center"`.

We can include images that are not generated in R by using the `include_graphics()` function in an R chunk (as long as `knitr` has been loaded in an earlier chunk). We simply pass the relative path to an image into this function. For example, as long as the file `"Homer_Simpson_2006.png` is in the *working directory* (remember that the working directory in R Markdown is set to the directory of the `.Rmd` file), then the following:

```{r, comment = NA, echo = FALSE}
cat("```{r, echo = FALSE}
include_graphics(\"Homer_Simpson_2006.png\")
```")
```

will typeset as:

```{r, echo = FALSE}
include_graphics("litprog/images/Homer_Simpson_2006.png")
```

(This is a key case where `echo = FALSE` is useful, because the code is not doing anything except displaying a figure.)

**Note that you must use `out.width` and `out.height` to scale external images (`fig.height` and `fig.width` won't work)** e.g.

```{r, comment = NA, echo = FALSE}
cat("```{r, echo = FALSE, out.width = \"20%\"}
include_graphics(\"Homer_Simpson_2006.png\")
```")
```

```{r, echo = FALSE, out.width = "20%"}
include_graphics("litprog/images/Homer_Simpson_2006.png")
```

```{task}
You should have access to a `fruitfly.jpg` file, which was downloaded from Wikipedia and shared under a CC 4.0 Licence---see  [https://commons.wikimedia.org/wiki/File:Drosophila_melanogaster_Proboscis.jpg](https://commons.wikimedia.org/wiki/File:Drosophila_melanogaster_Proboscis.jpg) for details.

Display this as an image in your `ff.Rmd` file and compile. Have a play with setting the figure size and caption.
```

### Tables

Tables can also be produced directly from R code, and typeset neatly. The tricky thing is of course converting the table into different formats depending on the output file (e.g. HTML/PDF/Word) that you want to use. A helper function provided in the `knitr` package is called `kable()`. Here you can simply pass a `data.frame` object to the `kable()` function and it will convert to the correct output format automatically. For example:

```{r, comment = NA, echo = FALSE}
cat("```{r, echo = FALSE}
kable(cars[1:6, ])
```")
```

will typeset as:

```{r, echo = FALSE}
kable(cars[1:6, ])
```

(You can see how the formatting differs in the HTML notes compared to the PDF notes.)

This is not particularly neat yet, but there are some additional options that can help, such as `align` to set the column alignments, and `col.names` that allows you to update the column names on-the-fly. For example:

```{r, comment = NA, echo = FALSE}
cat("```{r, echo = FALSE}
kable(
    cars[1:6, ], 
    align = \"c\", 
    col.names = c(\"Speed (mph)\", \"Stopping distance (ft)\"), 
    format = ifelse(is_html_output(), \"html\", \"pipe\"))
```")
```

produces

```{r, echo = FALSE}
kable(cars[1:6, ], align = "c", col.names = c("Speed (mph)", "Stopping distance (ft)"), format = ifelse(is_html_output(), "html", "pipe"))
```

(Note that the `format = ifelse(is_html_output(), "html", "pipe")` is a useful thing to add, which switches the output table type depending on whether the markdown is to be rendered into a HTML document or something else. This shouldn't be necessary, but there seems to be an issue with column header alignments in HTML documents if you don't include it.)

```{info, title = "kableExtra", collapsible = FALSE}
`kable()` itself is relatively lightweight, and doesn't allow for sophisticated table formatting. There is however another great package called `kableExtra`, which can be installed in the usual way and gives much more flexibility around formatting. If you're interested, then more information can be found in the online vignette [here](https://haozhu233.github.io/kableExtra/awesome_table_in_html.html#Overview).
```

```{info, title = "gt", collapsible = FALSE}
There has recently been a package released called [`gt`](https://gt.rstudio.com/), which looks awesome. It is currently still in the early release stage (although it is on CRAN), and I haven't used it in anger yet, which is why I haven't expanded on it here. However, feel free to install and have a play if you like! (My early-access opinion is that it seems a little sketchy for some more complex tables when producing PDF outputs, but is really good for HTML outputs. I hope that it will improve over time because the syntax and flexibility is great.)
```

Note that sometimes, you might want to format the cells of the different columns separately. For example, there is a `digits` argument to `kable()`, that can be used to round decimal numbers to a certain number of significant figures. Alternatively, another option is to round and format numbers in the `data.frame` object itself before you use it in `kable()`. This can be easily done using **pipes**, which avoids changing the original data set at all but gives you more control over how the table is presented.

As an example, consider a made-up data frame:

```{r, include = FALSE}
set.seed(555)
```

```{r}
test <- data.frame(x = c(rnorm(2, 0, 1), rnorm(2, 1000000, 5000)))
test
```

Here is some code that uses the function `format()` to format these numbers in different ways. We will do this by copying the column multiple times and reformatting each time. The first column is the default, and other choices are described in the code below. Note that I've done this without pipes just to make commenting easier to understand.

```{r}
## create column with scientific notation turned off
test$x1 <- format(test$x, scientific = FALSE)

## create column that rounds to 2 decimal places
test$x2 <- format(test$x, scientific = FALSE, digits = 2)

## create column that drops trailing zeros
test$x3 <- format(test$x, scientific = FALSE, digits = 2, drop0trailing = TRUE)

## create column that rounds big numbers to the nearest integer
## and small numbers to 2dp
test$x4 <- format(
    ifelse(test$x > 100, round(test$x, 0), round(test$x, 2)), 
    scientific = FALSE, digits = 2, drop0trailing = TRUE)

## create column that uses commas to separate large multiples of 10
test$x5 <- format(
    ifelse(test$x > 100, round(test$x, 0), round(test$x, 2)), 
    scientific = FALSE, digits = 2, drop0trailing = TRUE,
    big.mark = ",")

## format table
kable(test, align = "c", format = ifelse(is_html_output(), "html", "pipe"))
```

Hopefully this begins to give you an idea of what is possible here, rather than just printing a `data.frame` object to the screen.

## Mathematical equations

R Markdown also allows for the use of mathematical equations through the use of LaTeX commands. For example, the inline code `$\int_0^5 x^2 dx$` will typeset as: $\int_0^5 x^2 dx$. Similarly, **display style** equations can be included by enclosing in double `$` statements, so the code `$$\int_0^5 x^2 dx$$` will typeset as: $$\int_0^5 x^2 dx.$$

You may not need to use mathematical notation very often, but being able to typeset equations is a necessary part of data science, particularly when it comes to presenting statistical models. As such, you do not need to know all the ins-and-outs of how to write formal LaTeX documents (`rmarkdown` will do the heavy-lifting here), but there is some useful guidance on how to write mathematics that can be used in `rmarkdown` documents, which can be found here [https://www.andy-roberts.net/writing/latex/mathematics_1](https://www.andy-roberts.net/writing/latex/mathematics_1). Another useful site is [DeTeXify](http://detexify.kirelabs.org/classify.html), which allows you to hand-draw a symbol and it will find the correct LaTeX term for you! A useful list of common LaTeX symbols can be found at [https://www.caam.rice.edu/~heinken/latex/symbols.pdf](https://www.caam.rice.edu/~heinken/latex/symbols.pdf).

```{task}
Add a linear regression equation: $y_i = \beta_0 + \beta_1 x_i$ to one of your `.Rmd` files and see how it typesets.
```

```{solution}
Here an underscore `_` allows for **subscripts**, a hat symbol `^` allows for **superscripts**. Greek symbols can be denoted using their names prefixed by a backslash e.g. `\beta`. 

`$y_i = \beta_0 + \beta_1 x_i$`

```

```{info, title = "Note", collapsible = FALSE}
Even though this uses LaTeX notation, it will compile using the MathJax Javascript library for HTML files, and automatically convert to Equation format in Word.
```

```{info, title = "Note", collapsible = FALSE}
If you ever do want to learn LaTeX, then please see a great tutorial by Andy Roberts at [https://www.andy-roberts.net/writing/latex](https://www.andy-roberts.net/writing/latex).
```

## Referencing

R Markdown also supports bibliographic referencing using a [BibTeX](https://www.bibtex.org/)-style bibliographic manager. This is a format used in LaTeX documents, but in essence simply means that rather than use a manager such as EndNote, Zotero or Mendeley, instead you record your references in a simple text file with the suffix `.bib`. The references must be written in a specific format, but these can easily be downloaded through the **citation download** button on most journal papers. For the format of different types of reference, such as articles, books or technical reports, please see [https://en.wikipedia.org/wiki/BibTeX](https://en.wikipedia.org/wiki/BibTeX). 

```{info, title = "Note", collapsible = FALSE}
Note that references stored in other formats (e.g. EndNote, Zotero or Mendeley) can be **exported** to BibTeX if required. (A quick Google search gives lots of resources online to convert between EndNote, Zotero, Mendeley and BibTeX, so let me know if you have any issues with this.) This means that you can store your references in say Zotero if you prefer (and if you already use this), and simply export the ones you need to a BibTeX file if you want to pass them to R Markdown.
```

For example, a BibTeX entry for [Partridge and Farquhar (1981)](https://www.nature.com/articles/294580a0#citeas) would be:

```{r, fig.cap = "Partridge and Farquhar (1981) BibTeX entry", eval = FALSE, echo = TRUE}
@article{partridge_farquhar:1981,
	author = {Linda Partridge and Marion Farquhar},
	title = {Sexual activity reduces lifespan of male fruitflies},
	volume = {294},
	pages = {580--582},
	year = {1981},
	doi = {10.1038/294580a0},
	journal = {Nature}
}
```

The first part of the BibteX entry, `partridge_farquhar:1981` is a **unique identifier** for the reference, and can be changed to anything you like. 

I wrote the above entry by hand. Conversely, Figure \@ref(fig:citation) shows an example where the BibTeX entry can be downloaded directly, for [Spiegelhalter (2020)](https://www.bmj.com/content/370/bmj.m3259).

```{r, citation, fig.cap = "BMJ Citation Download", echo = FALSE, out.width = "60%", out.height = "60%"}
include_graphics("litprog/images/citation.png")
```

If we save all the references we need into a file called e.g. `references.bib`, then we can add this file to the YAML as follows:

```{r, echo = FALSE, comment = NA}
cat("---
title: \"Untitled\"
output: html_document
bibliography: references.bib
---")
```

```{info, title = "Note", collapsible = FALSE}
If `references.bib` is **not** stored in the **working directory**, then you will have to add the full path to the file in the YAML. Hence it is better to store it in the working directory.
```

The unique identifiers can then be used in the code wherever a reference is required e.g. `@partridge_farquhar:1981`, which will then typeset as Partridge and Farquhar (1981), and `[@partridge_farquhar:1981]` will typeset as (Partridge and Farquhar, 1981). This will also add the list of references to the end of the document. It's usually worthwhile adding an empty section to the end of your R Markdown code with the title **References** e.g.

```
# References
```

```{info, title = "Note", collapsible = FALSE}
Only entries that are cited in the document will appear in the reference list, so you are free to use a single `.bib` file for **all** your references if you like, and only the ones you reference in the R Markdown document will appear in your compiled document.
```

```{info, title = "Useful information regarding BibTeX files"}
Below are example `.bib` entries with some common types of reference you might want to include. These include:
    
* articles,
* books,
* chapters in books,
* manuals,
* websites.

You can use some of these as a basis for your own reference files. You'll notice that some fields are different for different types of reference. I've also chosen some of these examples to highlight a few important points regarding formatting of BibTeX files (because they are written in LaTeX rather than R Markdown, so a few things differ in terms of formatting---if you can't get something to work, then please e-mail me).

General things to remember:

* All authors should be separated using `and`. The formatting will be taken care of by the style file.
* Always use full author names if available. Any shortening of the names will be taken care of in the style file (sometimes full names are not provided though).
* Some style files automatically change title/journal names etc. to lower-case (but not authors thankfully). If there are specific letters you wish to always remain unchanged, please put these in curly brackets. For example, `{B}ritish` will ensure that the "B" is always capitalised, regardless of the style file.
* If you need to italicise something, then use `\textit{}` rather than `*` (since `\textit{}` is LaTeX code for italics). For example, species names such as *Mycobacterium bovis* are always italicised, and so you can use `\textit{{M}ycobacterium bovis}` to format this correctly (notice that I've also put the `{M}` in curly brackets since it should always be capitalised).
* If you need to use accents over certain letters, then you will have to use LaTeX code for accents. Some examples can be found [here](https://en.wikibooks.org/wiki/LaTeX/Special_Characters). 
* Adding the [Digital Object Identifier (DOI)](https://www.doi.org/) helps to uniquely identify the resource (and in certain style files will automatically be hyperlinked to the correct entry at [https://www.doi.org/](https://www.doi.org/)).

Some examples of these ideas can be seen below.

Firstly, journal articles can be included using the `@article` class, as:

``
@article{mathewsetal:2006,
    author = {Fiona Mathews and David W. MacDonald and G. Michael Taylor and Merryl Gelling and Rachel A. Norman and Paul E. Honess and Rebecca Foster and Charlotte M. Gower and Susan Varley and Audrey Harris and Simonette Palmer and Glyn Hewinson and Joanne P. Webster},
    title = {Bovine tuberculosis (\textit{{M}ycobacterium bovis}) in {B}ritish farmland wildlife: the importance to agriculture},
    journal = {Proceedings of the Royal Society B: Biological Sciences},
    volume = {273},
    number = {1584},
    pages = {357--365},
    year = {2006},
    doi = {10.1098/rspb.2005.3298}
}
``

Notice that here we separate all authors using `and`, set some letters to be always capitalised using `{}`, and also format the species name for *Mycobacterium bovis* to be italicised.

Books can be referenced using `@book`, as:

``
@book{kalbfleisch_prentice:2002,
	author = {John D. Kalbfleisch and Ross L. Prentice},
	title = {The Statistical Analysis of Failure Time Data},
	publisher = {Wiley},
	edition = {2nd},
	year = {2002},
	doi = {10.1002/9781118032985}
}
``

Chapters in books can be referenced using `@inbook`, as:

``
@inbook{jegatetal:2008,
	author = {C. J\`{e}gat and F. Carrat and C. Lajaunie and H. Wackernagel},
	title = {Early Detection and Assessment of Epidemics by Particle Filtering},
	booktitle = {geoENV VI – Geostatistics for Environmental Applications},
	editor = {A. Soares and M. Pereira and R. Dimitrakopoulos},
	publisher = {Springer Netherlands},
	year = {2008},
	pages = {22--35}
}
``

Here we have included a grave accent where required. Note that the original paper only has initials for each name, so we can't add full names here.

Manuals can be included using `@manual`, as:

``
@manual{winbugs14:2003,
	author = {David Spiegelhalter and Andrew Thomas and Nicky Best and Dave Lunn},
	title = {WinBUGS User Manual, Version 1.4},
	year = {2003},
	url = {https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/manual14.pdf}
}
``

Notice that here we have included a URL to the software website. Finally, we can include websites via `@misc`, as:

``
@misc{citethemright:2023,
    title = {Cite Them Right Harvard},
    author = {{Cite Them Right}},
    year = 2023,
    url = {https://www.citethemrightonline.com/category-list?docid=CTRHarvard},
    urldate = {2023-11-16}
}
``

Notice that it is usual to add the date at which you accessed the website to your reference (`urldate` here), and notice also that to keep the author as `Cite Them Right` we've used curly brackets again (otherwise, the software may think that `Cite Them` are first names, and `Right` is a surname, and thus format the author as "Right, C. T.")!

```

### Referencing styles

By default, R Markdown uses a Chicago referencing style, which is an author-year style. Other formats (e.g. Vancouver, Harvard etc.) can be specified using Citation Style Language (CSL) files. A good resource for these is the [Zotero Style Guide](https://www.zotero.org/styles), where you can download a given style file and then simply link the downloaded style file to the document in the YAML (see below). 

```{info, title = "Important: style files", collapsible = FALSE}
The point of style files is to avoid you from having to do any manual formatting of your references or reference list. Almost all scientific journals provide style files for journal submissions, which can be linked to e.g. EndNote, Zotero or Mendeley (if you are writing a document in Word for example), or to BibTeX.

This has many advantages. For example, if you resubmit your work to a different journal, then you only have to replace the original style file with a new one, and all of your references automatically update to the new format without any manual intervention!
    
Of course, it may be that you can't download a style file that matches the **exact specification** required. If this is the case, then you can manually edit the style file (since it is just a text file after all), however, this does require some understanding of how style files operate. **You will not have to manually edit style files in this course.** However, a useful resource if you ever need it in the future can be found on the [Zotero](https://www.zotero.org/support/dev/citation_styles/style_editing_step-by-step) website.
    
To be consistent with the other Medical Sciences courses, we will use a **Harvard** style in this module. Unfortunately the University *does not* provide style files for the exact formatting requirements they use, specifically the ones described on Cite Them Right:
    
[https://www.citethemrightonline.com/category-list?docid=CTRHarvard](https://www.citethemrightonline.com/category-list?docid=CTRHarvard)

However, I have created a version that I think is close to the correct one, which can be used as described below.
```

To change to the Exeter Harvard style, download the `r ifelse(!is_latex_output(), "[\u0060 harvard-exeter.csl \u0060](litprog/uploadFiles/harvard-exeter.csl) file", "\\texttt{harvard-exeter.csl} from ELE")`, put it in the working directory, and then add the following line to the YAML:

```{r, echo = FALSE, comment = NA}
cat("csl: harvard-exeter.csl")
```

and then recompile the document.

For more details please see the [R Markdown Cookbook section on bibliographies](https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html).

```{task}
Add a reference to [Partridge and Farquhar (1981)](https://www.nature.com/articles/294580a0#citeas) to your `ff.Rmd` file using the approach described above.
```

```{task}
Change the bibliography style to Harvard in `ff.Rmd`, using the `harvard-exeter.csl` file and the approach described above.
```

```{task}
Download one of the Vancouver style files from the [Zotero Style Guide](https://www.zotero.org/styles) repository, and change the bibliography style in `ff.Rmd` to use this new file. Examine the compiled document to see the effect that the style file has on the way the references and reference list are formatted.
```

```{info, title = "**Important: coursework**", collapsible = FALSE}
For any coursework in this module I would like you to use the `harvard-exeter.csl` style file provided. If there are any differences between this file and the exact [Cite Them Right](https://www.citethemrightonline.com/category-list?docid=CTRHarvard) criteria, then, for **THIS module** only, **the `harvard-exeter.csl` style file will take precedence**.

I **do not** expect you to manually edit your references or style file here, as long as you use the correct file then I will be happy.

However, if there are any differences between the style file and Cite Them Right that you notice, please do let me know and I can update the style file for the future.
```

## Additional features

### Purling

```{info, title = "Warning", collapsible = FALSE}
Before you do the next part, make sure you have a backup of your `ff.R` script file!
```

A final point to note is that although it takes a bit of effort to turn an R script file into an R Markdown document, it takes no time at all to do the reverse. This is because `knitr` includes a very useful function called `purl()`, that takes the name of an R Markdown file as an argument, extracts all of the code, and creates a new R script file containing *just* the source code. If your R Markdown file is called `FILE.Rmd`, then by default, `purl` will create a file called `FILE.R`. There is an `output` argument to `purl()` that enables you to specify a different file name. (Hence why I said to be careful to make a backup of `ff.R` above).

```{info, title = "Note", collapsible = FALSE}
Make sure `knitr` is explicitly loaded using `library(knitr)` for the next component, or use `knitr::purl()`.
```

For example, the test document we were playing around with I called `test.Rmd`. Hence,

```{r, eval = FALSE}
purl("test.Rmd")
```

creates a new document in the working directory called "test.R", which looks like:

```{r code = readLines("litprog/test.R"), eval = FALSE}
```

If you want a different output file name, try something like:

```{r, eval = FALSE}
purl("test.Rmd", output = "testscript.R")
```

Note that R overwrites files by default, so if you run `purl` multiple times you will overwrite previous versions of the script. So be careful!

Notice that the first chunk is not necessary to include in the R script (it sets `knitr` options). We can set a `purl = FALSE` option to an R chunk to tell `knitr` to **exclude** the chunk when calling `purl`. Amending the first chunk in `test.Rmd` to be:

```{r, comment = NA, echo = FALSE}
cat("```{r setup, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```")
```

and then calling `purl` again, will remove this code chunk from `test.R`.

I also find that adding the `documentation = 0` option to `purl()` will remove the chunk options that are included as comments in the extracted code. **This will retain comments that are included in each chunk however, so all is good there.**

```{r, eval = FALSE}
purl("test.Rmd", documentation = 0)
```

```{r, code = readLines("litprog/test1.R"), eval = FALSE}
```

```{info, title = "Important", collapsible = FALSE}
If you run `purl()` multiple times to the same output file and the **code doesn't change**, then it **does not overwrite** (or at least doesn't on my machine). Hence you might need to delete the extracted R script before re-running `purl()` with different `documentation` options.
```

```{task}
Take your R Markdown document created in the previous task (`ff.Rmd`), and `purl` it to create a script file (be careful to have a backup of your original `ff.R` script in case you overwrite it).
```

This makes it easy to share code amongst collaborators. It also means you can write documents with outputs in mind, and work with markdown scripts directly, rather than writing source code and then converting to outputs when finalising analyses. It also forces you to think **succinctly**, and to write analyses that are **readable**. **Nothing highlights verbose practices more than seeing all the inputs and outputs interspersed!**

### Caching

Another feature of R Markdown is the ability to **cache** results. This means that outputs for chunks that have not changed are stored, and do not have to be rerun every time the document is recompiled. This is really useful if you have several sections of code that take a long time to run. Setting the `knitr::opts_chunk$set(cache = TRUE)` option will turn caching on. You can turn it on or off from specific chunks by setting a `cache = TRUE` or `cache = FALSE` option in the chunk settings. As usual, local chunk options overwrite global ones. The cached files are stored in two folders in the working directory called `FILENAME_cache` and `FILENAME_files`, where `FILENAME` is the name of your `.Rmd` file. **To remove the cached files, simply delete these two folders.**

I generally only do this if some of the code will take a while to run, and I generally delete the cache and rerun from scratch before submitting my final document / code, to ensure reproducibility.

```{info, title = "Warning", collapsible = FALSE}
If you use un-named chunks, then `knitr` automatically generates names, hence adding new chunks in will cause the later chunks to be re-run (since the chunk names will change). Also (I think), chunks are only re-run if something changes about the chunk code. Hence if earlier chunks re-create objects used in later chunks, these later chunks will only be re-run if the **code** changes, not if the object used in the chunk changes. Hence we must be a bit wary when using caching.
```

## Further extensions

### Presentations

You can even write presentations in R Markdown. For example, to write a simple presentation based on [Google's IO theme](https://code.google.com/archive/p/io-2012-slides/), you can follow a tutorial [here](http://rmarkdown.rstudio.com/ioslides_presentation_format.html). A Javascipt library I particularly like is [reveal.js](http://lab.hakim.se/reveal-js/#/), which can be implemented in R Markdown easily [here](http://rmarkdown.rstudio.com/revealjs_presentation_format.html). These produce HTML presentations that can be viewed in a web browser. If you want a more traditional approach, you can even use LaTeX's [beamer](https://en.wikipedia.org/wiki/Beamer_(LaTeX)) class to produce PDF slides, as done [here](http://rmarkdown.rstudio.com/beamer_presentation_format.html).

```{task}
Write a simple presentation with a couple of slides that highlights the key points from your fruitfly analysis you conducted earlier.
```

### Bookdown

An absolutely brilliant package, written again by [Yihui Xie](https://yihui.org/en/), is `bookdown`, which enables you to write print-ready books using R Markdown. This includes a load of additional features, like better cross-referencing and bibliographic features. Bookdown can also be used to create simpler documents such as those produced as standard by `rmarkdown`, but that enable you to implement some of the `bookdown` features.

All of the lecture notes for this module have been written using `bookdown`. However, I have also developed customised code and templates to build in additional features, such as the `task` and `solution` boxes and suchlike, and to ensure they work when compiled to either HTML or PDF format. Similarly, all the slides and handouts were also written using `rmarkdown` with custom templates to ensure that the slides can be compiled into HTML or PDF (PDF typesets better, and is better for handouts, but is not (currently) screen-reader compatible, whereas HTML slides are, so it's great to have both options to help improve accessibility). I dislike Word, and so don't go anywhere near that unless I have to!

Yihui Xie's `bookdown` book can be found at [https://bookdown.org/](https://bookdown.org/).

This is the beauty of **open-source** software---you are free to develop code further and build on the amazing work done by other developers. I use open-source software every day in my research, and try to give a small part back by making various pieces of software and R packages publicly available through e.g. GitHub, so that others can use them if they wish. It is through a shared sense of altruism that the open-source software ecosystem continues to thrive.

## Additional task

```{task}
Take the analysis we conducted in Chapter \@ref(spiegelhalter), and create a short R script that reads in the relevant data files and creates the main figure that we produced in the earlier workshop. Convert this into R Markdown and produce a short report, with some descriptive text, but hiding all the code in the compiled document. Add any references using the Harvard (Exeter) style as necessary.
```

```{solution, code = readLines("litprog/covid.Rmd"), eval = FALSE}
```
